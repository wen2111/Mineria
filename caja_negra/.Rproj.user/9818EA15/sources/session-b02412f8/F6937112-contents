---
title: "NA"
output: html_document
date: "2025-10-11"
---

```{r}
load("~/GitHub/Mineria/.RData")
library(naniar)
library(ggplot2)
library(visdat)
library(dplyr)
library(tidyr)
library(Hmisc)
```

# Exploración de los NA

Realizamos un test de Little para comprobar si los NA de nuestros datos son MCAR (aleatorios) o si por el contrario siguen algún patron.
```{r}
naniar::mcar_test(data)
```

Dado que el pvalor es ampliamente superior a 0.05, aceptamos la hipótesis nula: no hay evidencia estadística para sospechar que los valores faltantes de nuestra base de datos no son fruto de la aleatoriedad.

Vamos a visualizar la distribución de nuestros NA para las diferentes variables.

```{r}
vis_dat(data)
```

Tampoco se observa ningún patrón fuera de los generados para este problema concreto del caso del banco (ID, group, Exited).

Cantidad de NA por variable:
```{r}
gg_miss_var(data) + labs(y = "Look at all the missing ones")
```
Ya habíamos visto que en todas las variables la proporción de NA es del 30%. Esto no pasa para ID, dado que los datos test no tienen valores faltantes ni para group, variable que hemos generado nosotros para indicar si una observación es grupo train/test.



```{r}
pct_miss_case(data)
```

# Imputación de los NA

## Imputación por media y mediana
```{r fig.width=14, fig.height=10}
data_mean <- data %>%
  mutate(across(where(is.numeric),
                ~ Hmisc::impute(., fun = mean),
                .names = "imputed_mean_{.col}"))

data_median <- data %>%
  mutate(across(where(is.numeric),
                ~ Hmisc::impute(., fun = median),
                .names = "imputed_median_{.col}"))

data_all <- data %>%
  bind_cols(
    select(data_mean, starts_with("imputed_mean_")),
    select(data_median, starts_with("imputed_median_"))
  )


df_long_all <- data_all %>%
  select(where(is.numeric)) %>%
  pivot_longer(
    cols = everything(),
    names_to = "VariableCompleta",
    values_to = "Valor"
  ) %>%
  mutate(
    Tipo = case_when(
      grepl("^imputed_mean_", VariableCompleta) ~ "Media",
      grepl("^imputed_median_", VariableCompleta) ~ "Mediana",
      TRUE ~ "Original"
    ),
    Variable = gsub("^(imputed_mean_|imputed_median_)", "", VariableCompleta)
  )
ggplot(df_long_all, aes(x = Valor, fill = Tipo)) +
  geom_density(alpha = 0.3) +
  facet_wrap(~ Variable, scales = "free") +
  theme_minimal() +
  labs(title = "Comparación de imputación por media y mediana",
       fill = "Tipo de dato")
```


Observamos como ni la media ni la mediana parecen métodos fiables para la imputación de ninguna de las numéricas, puesto que la densidad de ninguno de las dos metodologías se ajusta bien a la densidad orignal de los datos sin NA.


## Media con variable target

```{r fig.width=14, fig.height=10}
data_imputado <- data

var_numericas <- names(data_imputado)[sapply(data_imputado, is.numeric)]
var_numericas <- var_numericas[var_numericas != "Exited"]

data_imputado <- data_imputado %>%
  group_by(Exited) %>%
  mutate(across(all_of(var_numericas), 
                ~ {
                  media_grupo <- mean(., na.rm = TRUE)
                  ifelse(is.na(.), media_grupo, .)
                })) %>%
  ungroup()

df_original <- data %>%
  select(where(is.numeric)) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Variable",
    values_to = "Valor"
  ) %>%
  mutate(Tipo = "Original")

df_imputado <- data_imputado %>%
  select(where(is.numeric)) %>%
  pivot_longer(
    cols = everything(),
    names_to = "Variable",
    values_to = "Valor"
  ) %>%
  mutate(Tipo = "Imputado")

df_comparacion <- bind_rows(df_original, df_imputado)

ggplot(df_comparacion, aes(x = Valor, fill = Tipo)) +
  geom_density(alpha = 0.5) +
  facet_wrap(~ Variable, scales = "free") +
  theme_minimal() +
  labs(title = "Comparación de distribuciones: Pre vs Post Imputación (Media por Grupo)",
       x = "Valor", 
       y = "Densidad",
       fill = "Tipo de dato") +
  scale_fill_manual(values = c("Original" = "red", "Imputado" = "blue"))
```
Vemos que la imputación de media con una variable target (en este caso exited) tampoco representa una opción fiable de cara a la imputación de datos faltantes, dado que no respeta la densidad original para ninguna de las variables numéricas
