---
title: "outliers-multi"
author: "Laura Belmonte"
date: "2025-10-04"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,echo=FALSE}
train_data<-read.csv2("train.csv", sep=",")
test_data<-read.csv2("test.csv", sep=",")
#submit_data<-read.csv2("sample_submission.csv", sep=",")
train_data$group<-"train"
test_data$group<-"test"
train_data<-train_data[,-1]
test_data$Exited<-NA
common_columns <- intersect(names(train_data), names(test_data))
#common_columns
train_data <- train_data[,common_columns]
test_data <- test_data[,common_columns]
data<-rbind(train_data,test_data)
data <- data[, c("Exited", setdiff(names(data), "Exited"))]
varCat<-c("Geography", "Gender", "MaritalStatus", "EducationLevel","HasCrCard", 
          "SavingsAccountFlag", "LoanStatus","CustomerSegment","Exited","group" ,"IsActiveMember")
varNum<-c("Age", "CreditScore", "Tenure","EstimatedSalary", "Balance", "NumOfProducts",
          "TransactionFrequency","AvgTransactionAmount","DigitalEngagementScore",
          "ComplaintsCount","NetPromoterScore")
data[varCat] <- lapply(data[varCat], factor)
data[varNum] <- lapply(data[varNum], as.numeric)
#str(data)
```

Hasta ahora hemos visto cada variable por separado mediante diferentes métodos para detectar sus outliers segun las propiedades individuales de cada variable. 

No obstante, a veces los outliers aparecen en combinación de variables. Así pues estudiaremos los outliers mediante métodos multivariantes

Para detectarlos se pueden usar métodos como la distancia de Mahalanobis o algoritmos más avanzados de detección de anomalías. 

## Distancia de Mahalanobis 

```{r}
dades <- data[, varNum]
for(v in varNum){
  dades[[v]] <- as.numeric(as.character(dades[[v]]))
}

dades2 <- na.omit(dades)

distancia_mahalanobis <- mahalanobis(
  dades2,
  center = colMeans(dades2),
  cov    = cov(dades2)
)
#Graficamos el plot de la densidad de las distancias
plot(density(distancia_mahalanobis))
```

El gráfico sugiere que la gran mayoría de los clientes están dentro de un rango normal, no obstante, existe un grupo pequeño con distancias muy elevadas que se pueden considerar claramente outliers. 

La cola larga a la derecha es la señal principal de anomalías.

Ara se muestran aquellos individuos de la bbdd que quedan sobre del 99% de la distribución $\chi^2$

```{r}
cutoff <- qchisq(p = 0.99, df = ncol(dades2))
dades2[distancia_mahalanobis>cutoff, ]
```

En el extracto mostrado se identifican varios valores que podrían considerarse atípicos en comparación con el resto de los datos. Por ejemplo, la edad de 84 años resulta inusualmente elevada dentro de una población bancaria típica. De manera similar, saldos muy altos como 134,096.53 o 120,656.86 contrastan marcadamente con aquellos clientes que incluso mantienen un balance de cero. Además, la frecuencia y el monto promedio de las transacciones varían de forma considerable entre los clientes, lo que sugiere la existencia de comportamientos extremos en el uso de productos financieros. 

Se ordenan estas variables de manera descendiente 

```{r}
dades2 <- dades2[order(distancia_mahalanobis, decreasing = TRUE),]
par(mfrow=c(1,1))
hist(distancia_mahalanobis)
```

El histograma de la distancia de Mahalanobis muestra que la mayoría de las observaciones tienen valores bajos (entre 5 y 15), mientras que unas pocas presentan distancias mucho más altas (superiores a 25), lo que indica la presencia de posibles outliers multivariantes en el conjunto de datos.

Per estudiar la relación entre variables hacemos un scatterplot 3D de los outliers multivariantes. 

Elegimos las variables: Age, Balance, EstimatedSalary

El gráfico 3D muestra la relación entre edad, balance y salario estimado, donde los puntos negros representan los valores normales y los rojos indican outliers detectados mediante la distancia de Mahalanobis; estas anomalías corresponden a individuos con combinaciones atípicas de variables que se alejan del patrón general de la muestra.

```{r}
library(scatterplot3d)
library(plotly)
umbral <- 8

# Crear columna de outlier
dades2$outlier <- (distancia_mahalanobis > umbral)

# Colores para outliers vs normales
dades2$color <- ifelse(dades2$outlier, "red", "black")

scatterplot3d(dades2[, "Age"], 
              dades2[, "Balance"], 
              dades2[, "EstimatedSalary"],
              color = dades2$color,
              pch = 19,
              main = "Outliers según distancia de Mahalanobis")

fig <- plot_ly(dades2, 
               x = ~Age, 
               y = ~Balance, 
               z = ~EstimatedSalary,
               color = ~outlier,
               colors = c("black", "red"),
               marker = list(size = 4)) %>%
       add_markers() %>%
       layout(title = "Outliers multivariantes (Mahalanobis)")
fig

(who <- which(dades2[, "outlier"] == TRUE))
```

## Local outlier Factor

El método Local Outlier Factor (LOF) evalúa si un punto de los datos es un valor atípico comparando su densidad local con la de sus vecinos más cercanos. La idea central consiste en que, si un punto presenta una densidad significativamente menor que la de su entorno, se considera una anomalía o outlier.

```{r}
library(Rlof)
library(dplyr)
library(rgl)  # para gráficos 3D

# Selección de tres variables numéricas
dades_sel <- dades2[, c("Age", "Balance", "EstimatedSalary")]

# Calcular LOF usando Rlof
outlier.scores <- Rlof::lof(dades_sel, k = 5)

# Ver distribución de los scores
plot(density(outlier.scores), main = "Distribución LOF (k=5)")

# 5 principales outliers
outliers <- order(outlier.scores, decreasing = TRUE)[1:5]

# biplot PCA
n <- nrow(dades_sel)
labels <- rep(".", n)
labels[outliers] <- "+"
biplot(prcomp(dades_sel), cex = .8, xlabs = labels)

# outliers en pares de variables
pch <- rep(".", n)
pch[outliers] <- "+"
col <- rep("black", n)
col[outliers] <- "red"
pairs(dades_sel, pch = pch, col = col, main = "Outliers detectados por LOF")

# Gráfico 3D
plot3d(dades_sel[,1], dades_sel[,2], dades_sel[,3],
       type = "s", col = col, size = 1,
       xlab = "Age", ylab = "Balance", zlab = "EstimatedSalary")

```

Se detectan clientes con comportamientos inusuales, como alguien muy joven con balance muy alto, personas con salarios estimados extremadamente diferentes al resto, o combinaciones de características que no siguen el patrón típico de la mayoría de observaciones.


